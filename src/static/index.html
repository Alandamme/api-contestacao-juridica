<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>API de Gera√ß√£o de Contesta√ß√£o Jur√≠dica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (mant√©m seus estilos originais intactos aqui...) -->
</head>
<body>
  <!-- (mant√©m seu layout HTML original aqui...) -->

<script>
  let sessionFile = null;
  const API_BASE = window.location.origin + '/api';

  function renderParte(parte) {
    if (!parte) return 'N√£o identificado';
    if (typeof parte === 'string') return parte;
    let res = '';
    if (parte.nome) res += `<b>Nome:</b> ${parte.nome}<br>`;
    if (parte.qualificacao) res += `<b>Qualifica√ß√£o:</b> ${parte.qualificacao}<br>`;
    if (parte.endereco) res += `<b>Endere√ßo:</b> ${parte.endereco}<br>`;
    return res || 'N√£o identificado';
  }

  async function uploadPDF() {
    const fileInput = document.getElementById('pdfFile');
    const file = fileInput.files[0];
    if (!file) {
      showResult('uploadResult', 'Por favor, selecione um arquivo PDF.', 'error');
      return;
    }

    const uploadBtn = document.getElementById('uploadBtn');
    const loading = document.getElementById('uploadLoading');
    uploadBtn.disabled = true;
    loading.style.display = 'block';

    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch(API_BASE + '/upload', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      if (response.ok) {
        sessionFile = result.session_file;
        document.getElementById('generateBtn').disabled = false;

        let dados = result.dados_extraidos || {};
        let message = `<strong>‚úÖ Arquivo processado com sucesso!</strong><br><br>`;
        message += `<b>Tipo de a√ß√£o:</b> ${dados.tipo_acao || 'N√£o identificado'}<br>`;
        message += `<b>Valor da causa:</b> ${dados.valor_causa || 'N√£o identificado'}<br>`;
        message += `<b>Autor:</b><br>${renderParte(dados.autor)}<br>`;
        message += `<b>R√©u:</b><br>${renderParte(dados.reu)}<br>`;

        if (dados.fatos) message += `<br><b>Resumo dos Fatos:</b><div class='preview'>${dados.fatos}</div>`;
        if (Array.isArray(dados.pedidos)) {
          message += `<br><b>Pedidos do Autor:</b><ul>`;
          dados.pedidos.forEach(p => message += `<li>${p}</li>`);
          message += `</ul>`;
        }
        if (Array.isArray(dados.fundamentos_juridicos)) {
          message += `<br><b>Fundamentos Jur√≠dicos:</b><ul>`;
          dados.fundamentos_juridicos.forEach(f => message += `<li>${f}</li>`);
          message += `</ul>`;
        }
        if (Array.isArray(result.warnings) && result.warnings.length) {
          message += `<br><strong>‚ö†Ô∏è Avisos:</strong><br>`;
          result.warnings.forEach(warning => message += `‚Ä¢ ${warning}<br>`);
        }
        message += `<div class="info">A contesta√ß√£o ser√° gerada conforme o <b>padr√£o do escrit√≥rio</b>. Para personalizar, edite o arquivo <code>contestacao_padrao.txt</code> no projeto.</div>`;
        showResult('uploadResult', message, 'success');
      } else {
        showResult('uploadResult', `‚ùå Erro: ${result.error}`, 'error');
      }
    } catch (error) {
      showResult('uploadResult', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
    } finally {
      uploadBtn.disabled = false;
      loading.style.display = 'none';
    }
  }

  async function generateContestacao() {
    if (!sessionFile) {
      showResult('generateResult', 'Por favor, fa√ßa o upload de um PDF primeiro.', 'error');
      return;
    }

    const tipo = document.getElementById('tipoGeracao').value;
    let endpoint = '/generate-contestacao';
    if (tipo === 'modelo-ia') endpoint = '/gerar-contestacao-ia';
    if (tipo === 'ia-avancada') endpoint = '/gerar-contestacao-ia-avancada';

    const generateBtn = document.getElementById('generateBtn');
    const loading = document.getElementById('generateLoading');
    generateBtn.disabled = true;
    loading.style.display = 'block';

    const dadosReu = {
      advogado_reu: document.getElementById('advogadoReu').value || 'Advogado da Contestante',
      oab_numero: document.getElementById('oabNumero').value || '000.000',
      estado: document.getElementById('estado').value || 'SP'
    };

    try {
      const response = await fetch(API_BASE + endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_file: sessionFile, dados_reu: dadosReu })
      });

      const result = await response.json();
      if (response.ok) {
        let message = `<strong>‚úÖ Contesta√ß√£o gerada com sucesso!</strong><br><br>`;
        message += `<strong>ID da Contesta√ß√£o:</strong> ${result.contestacao_id}<br>`;
        message += `<div class="download-links">`;
        message += `<a href="${API_BASE}/download/txt/${result.contestacao_id}" target="_blank">üìÑ Baixar TXT</a>`;
        message += `<a href="${API_BASE}/download/word/${result.contestacao_id}" target="_blank">üìù Baixar Word</a>`;
        message += `<a href="${API_BASE}/download/pdf/${result.contestacao_id}" target="_blank">üìã Baixar PDF</a>`;
        message += `</div>`;
        message += `<br><strong>Preview da Contesta√ß√£o:</strong><div class="preview">${result.preview}</div>`;
        showResult('generateResult', message, 'success');
      } else {
        showResult('generateResult', `‚ùå Erro: ${result.error}`, 'error');
      }
    } catch (error) {
      showResult('generateResult', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
    } finally {
      generateBtn.disabled = false;
      loading.style.display = 'none';
    }
  }

  function showResult(elementId, message, type) {
    const resultDiv = document.getElementById(elementId);
    resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
  }

  window.onload = async function() {
    try {
      const response = await fetch(API_BASE + '/health');
      if (!response.ok) {
        showResult('uploadResult', '‚ö†Ô∏è API n√£o est√° respondendo corretamente', 'error');
      }
    } catch (error) {
      showResult('uploadResult', '‚ùå N√£o foi poss√≠vel conectar com a API', 'error');
    }
  };
</script>
</body>
</html>

