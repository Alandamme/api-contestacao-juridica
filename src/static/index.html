<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>API de Gera√ß√£o de Contesta√ß√£o Jur√≠dica</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
        .container { max-width: 750px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 0 18px #d3d3d3; padding: 32px 30px 30px 30px; }
        h1 { text-align: center; color: #274690; margin-bottom: 35px; }
        .section { margin-bottom: 34px; }
        label { display: block; margin-bottom: 7px; font-weight: bold; }
        input[type="file"], input[type="text"], select {
            padding: 9px; border-radius: 4px; border: 1px solid #ddd; width: 100%; margin-bottom: 8px;
        }
        button {
            padding: 12px 26px; border: none; border-radius: 4px; background: #274690; color: #fff;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 8px;
            transition: background 0.15s;
        }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #1e3567; }
        .result { margin-top: 20px; padding: 16px; border-radius: 6px; }
        .success { background: #eafbea; color: #217344; border: 1px solid #baf2c6; }
        .error { background: #ffe6e6; color: #a33; border: 1px solid #ffc2c2; }
        .info { background: #e9f2fb; color: #275377; border: 1px solid #b8dbfa; margin-top: 12px; }
        .preview {
            background: #f6f7fa; border: 1px solid #e4e8ef; padding: 13px 10px;
            border-radius: 6px; margin: 10px 0 8px 0; font-family: monospace; white-space: pre-wrap;
            max-height: 350px; overflow-y: auto;
        }
        .loading { display: none; text-align: center; margin: 20px 0; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #274690; border-radius: 50%;
            width: 38px; height: 38px; animation: spin 2s linear infinite; margin: 0 auto 8px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .download-links { margin: 18px 0 10px 0; }
        .download-links a {
            display: inline-block; margin-right: 9px; margin-bottom: 6px; padding: 8px 15px;
            background: #3db36b; color: #fff; text-decoration: none; border-radius: 4px;
            font-size: 15px;
        }
        .download-links a:hover { background: #217344; }
        .form-group { margin-bottom: 13px; }
        ul { margin: 6px 0 8px 18px; }
    </style>
</head>
<body>
<div class="container">
    <h1>üèõÔ∏è API de Gera√ß√£o de Contesta√ß√£o Jur√≠dica</h1>

    <div class="section">
        <h2>üìÑ 1. Upload da Peti√ß√£o Inicial</h2>
        <label for="pdfFile">Selecione o arquivo PDF da peti√ß√£o inicial:</label>
        <input type="file" id="pdfFile" accept=".pdf">
        <button onclick="uploadPDF()" id="uploadBtn">Analisar PDF</button>
        <div class="loading" id="uploadLoading">
            <div class="spinner"></div>
            <p>Analisando PDF...</p>
        </div>
        <div id="uploadResult"></div>
    </div>

    <div class="section">
        <h2>‚öñÔ∏è 2. Dados do R√©u (Opcional)</h2>
        <div class="form-group">
            <label for="advogadoReu">Nome do Advogado:</label>
            <input type="text" id="advogadoReu" placeholder="Ex: Dr. Jo√£o Silva">
        </div>
        <div class="form-group">
            <label for="oabNumero">N√∫mero da OAB:</label>
            <input type="text" id="oabNumero" placeholder="Ex: 123.456">
        </div>
        <div class="form-group">
            <label for="estado">Estado (UF):</label>
            <input type="text" id="estado" placeholder="Ex: SP" maxlength="2">
        </div>
    </div>

    <div class="section">
        <h2>üìù 3. Gerar Contesta√ß√£o</h2>
        <div class="form-group">
            <label for="tipoGeracao">Tipo de Gera√ß√£o:</label>
            <select id="tipoGeracao">
                <option value="normal">Modelo Padr√£o (sem IA)</option>
                <option value="modelo-ia">Modelo com IA</option>
                <option value="ia-avancada">IA Avan√ßada (com placeholders)</option>
            </select>
        </div>
        <button onclick="generateContestacao()" id="generateBtn" disabled>Gerar Contesta√ß√£o</button>
        <div class="loading" id="generateLoading">
            <div class="spinner"></div>
            <p>Gerando contesta√ß√£o...</p>
        </div>
        <div id="generateResult"></div>
    </div>
</div>

<script>
    let sessionFile = null;
    const API_BASE = window.location.origin + '/api';

    function renderParte(parte) {
        if (!parte) return 'N√£o identificado';
        if (typeof parte === 'string') return parte;
        let res = '';
        if (parte.nome) res += `<b>Nome:</b> ${parte.nome}<br>`;
        if (parte.qualificacao) res += `<b>Qualifica√ß√£o:</b> ${parte.qualificacao}<br>`;
        if (parte.endereco) res += `<b>Endere√ßo:</b> ${parte.endereco}<br>`;
        return res || 'N√£o identificado';
    }

    async function uploadPDF() {
        const fileInput = document.getElementById('pdfFile');
        const file = fileInput.files[0];
        if (!file) {
            showResult('uploadResult', 'Por favor, selecione um arquivo PDF.', 'error');
            return;
        }
        const uploadBtn = document.getElementById('uploadBtn');
        const loading = document.getElementById('uploadLoading');
        uploadBtn.disabled = true;
        loading.style.display = 'block';

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(API_BASE + '/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                sessionFile = result.session_file;
                document.getElementById('generateBtn').disabled = false;

                let dados = result.dados_extraidos;
                let message = `<strong>‚úÖ Arquivo processado com sucesso!</strong><br><br>`;
                message += `<b>Tipo de a√ß√£o:</b> ${dados.tipo_acao || 'N√£o identificado'}<br>`;
                message += `<b>Valor da causa:</b> ${dados.valor_causa || 'N√£o identificado'}<br>`;
                message += `<b>Autor:</b><br>${renderParte(dados.autor)}<br>`;
                message += `<b>R√©u:</b><br>${renderParte(dados.reu)}<br>`;

                if (dados.fatos) message += `<br><b>Resumo dos Fatos:</b><div class='preview'>${dados.fatos}</div>`;
                if (dados.pedidos?.length) {
                    message += `<br><b>Pedidos do Autor:</b><ul>`;
                    dados.pedidos.forEach(p => message += `<li>${p}</li>`);
                    message += `</ul>`;
                }
                if (dados.fundamentos_juridicos?.length) {
                    message += `<br><b>Fundamentos Jur√≠dicos:</b><ul>`;
                    dados.fundamentos_juridicos.forEach(f => message += `<li>${f}</li>`);
                    message += `</ul>`;
                }
                if (result.warnings?.length) {
                    message += `<br><strong>‚ö†Ô∏è Avisos:</strong><br>`;
                    result.warnings.forEach(warning => message += `‚Ä¢ ${warning}<br>`);
                }
                message += `<div class="info">A contesta√ß√£o ser√° gerada conforme o <b>padr√£o do escrit√≥rio</b>. Para personalizar, edite o arquivo <code>contestacao_padrao.txt</code> no projeto.</div>`;
                showResult('uploadResult', message, 'success');
            } else {
                showResult('uploadResult', `‚ùå Erro: ${result.error}`, 'error');
            }
        } catch (error) {
            showResult('uploadResult', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
        } finally {
            uploadBtn.disabled = false;
            loading.style.display = 'none';
        }
    }

    async function generateContestacao() {
        if (!sessionFile) {
            showResult('generateResult', 'Por favor, fa√ßa o upload de um PDF primeiro.', 'error');
            return;
        }

        const tipo = document.getElementById('tipoGeracao').value;
        let endpoint = '/generate-contestacao';
        if (tipo === 'modelo-ia') endpoint = '/gerar-contestacao-ia';
        if (tipo === 'ia-avancada') endpoint = '/gerar-contestacao-ia-avancada';

        const generateBtn = document.getElementById('generateBtn');
        const loading = document.getElementById('generateLoading');
        generateBtn.disabled = true;
        loading.style.display = 'block';

        const dadosReu = {
            advogado_reu: document.getElementById('advogadoReu').value || 'Advogado da Contestante',
            oab_numero: document.getElementById('oabNumero').value || '000.000',
            estado: document.getElementById('estado').value || 'SP'
        };

        try {
            const response = await fetch(API_BASE + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_file: sessionFile, dados_reu: dadosReu })
            });

            const result = await response.json();
            if (response.ok) {
                let message = `<strong>‚úÖ Contesta√ß√£o gerada com sucesso!</strong><br><br>`;
                message += `<strong>ID da Contesta√ß√£o:</strong> ${result.contestacao_id}<br>`;
                message += `<div class="download-links">`;
                message += `<a href="${API_BASE}/download/txt/${result.contestacao_id}" target="_blank">üìÑ Baixar TXT</a>`;
                message += `<a href="${API_BASE}/download/word/${result.contestacao_id}" target="_blank">üìù Baixar Word</a>`;
                message += `<a href="${API_BASE}/download/pdf/${result.contestacao_id}" target="_blank">üìã Baixar PDF</a>`;
                message += `</div>`;
                message += `<br><strong>Preview da Contesta√ß√£o:</strong><div class="preview">${result.preview}</div>`;
                showResult('generateResult', message, 'success');
            } else {
                showResult('generateResult', `‚ùå Erro: ${result.error}`, 'error');
            }
        } catch (error) {
            showResult('generateResult', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
        } finally {
            generateBtn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function showResult(elementId, message, type) {
        const resultDiv = document.getElementById(elementId);
        resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    window.onload = async function() {
        try {
            const response = await fetch(API_BASE + '/health');
            if (!response.ok) {
                showResult('uploadResult', '‚ö†Ô∏è API n√£o est√° respondendo corretamente', 'error');
            }
        } catch (error) {
            showResult('uploadResult', '‚ùå N√£o foi poss√≠vel conectar com a API', 'error');
        }
    };
</script>
</body>
</html>
