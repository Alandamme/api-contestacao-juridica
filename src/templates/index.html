<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Contestação Jurídica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<div class="container py-5">
  <h1 class="mb-4 text-center">
    <i class="bi bi-file-earmark-text-fill me-2"></i>Gerador de Contestação Jurídica
  </h1>

  <!-- Upload PDF -->
  <div class="card mb-4">
    <div class="card-header"><i class="bi bi-upload"></i> Enviar Petição Inicial (PDF)</div>
    <div class="card-body">
      <form id="upload-form">
        <input type="file" name="pdf" accept=".pdf" class="form-control mb-3" required>
        <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-up-circle"></i> Enviar</button>
      </form>
      <div id="upload-status" class="mt-3"></div>
    </div>
  </div>

  <!-- Dados extraídos -->
  <div class="card mb-4 d-none" id="dados-extraidos-card">
    <div class="card-header"><i class="bi bi-clipboard-data"></i> Dados Extraídos</div>
    <div class="card-body" id="dados-extraidos-preview"></div>
  </div>

  <!-- Dados do advogado -->
  <div class="card mb-4 d-none" id="advogado-card">
    <div class="card-header"><i class="bi bi-person-badge"></i> Dados do Advogado</div>
    <div class="card-body">
      <form id="advogado-form">
        <div class="mb-3">
          <label for="nome_advogado" class="form-label">Nome do Advogado</label>
          <input type="text" class="form-control" id="nome_advogado" required>
        </div>
        <div class="mb-3">
          <label for="oab" class="form-label">Número da OAB</label>
          <input type="text" class="form-control" id="oab" required>
        </div>
        <div class="mb-3">
          <label for="estado" class="form-label">Estado</label>
          <input type="text" class="form-control" id="estado" required>
        </div>
        <button type="submit" class="btn btn-success"><i class="bi bi-file-earmark-word-fill"></i> Gerar Contestação</button>
      </form>
    </div>
  </div>

  <!-- Resultado -->
  <div class="alert alert-success d-none mt-4" id="resultado"></div>
</div>

<script>
  let sessionFile = null;

  document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const status = document.getElementById("upload-status");
    status.innerHTML = "⌛ Enviando arquivo...";
    
    const res = await fetch("/api/upload", { method: "POST", body: formData });
    const data = await res.json();

    if (data.dados_extraidos) {
      sessionFile = data.dados_extraidos;

      const preview = document.getElementById("dados-extraidos-preview");
      preview.innerHTML = `
        <p><strong>Autor:</strong> ${sessionFile.autor}</p>
        <p><strong>Réu:</strong> ${sessionFile.reu}</p>
        <p><strong>Tipo de Ação:</strong> ${sessionFile.tipo_acao}</p>
        <p><strong>Valor da Causa:</strong> ${sessionFile.valor_causa}</p>
        <p><strong>Fatos:</strong> ${sessionFile.fatos}</p>
        <p><strong>Pedidos:</strong> <ul>${sessionFile.pedidos.map(p => `<li>${p}</li>`).join("")}</ul></p>
        <p><strong>Fundamentos Jurídicos:</strong> <ul>${sessionFile.fundamentos_juridicos.map(f => `<li>${f}</li>`).join("")}</ul></p>
      `;
      document.getElementById("dados-extraidos-card").classList.remove("d-none");
      document.getElementById("advogado-card").classList.remove("d-none");
      status.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> Dados extraídos com sucesso!</span>';
    } else {
      status.innerHTML = '<span class="text-danger">Erro ao processar PDF</span>';
    }
  });

  document.getElementById("advogado-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("nome_advogado").value;
    const oab = document.getElementById("oab").value;
    const estado = document.getElementById("estado").value;

    const res = await fetch("/api/gerar-contestacao", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        session_file: sessionFile,
        dados_advogado: { nome_advogado: nome, oab: oab, estado: estado }
      })
    });

    const resultado = document.getElementById("resultado");
    const data = await res.json();

    if (res.ok && data.files && data.files.word) {
      resultado.classList.remove("d-none");
      resultado.innerHTML = `✅ Contestação gerada! <a class="btn btn-outline-dark ms-2" href="${data.files.word}" target="_blank"><i class="bi bi-download"></i> Baixar Word</a>`;
    } else {
      resultado.classList.remove("d-none");
      resultado.classList.replace("alert-success", "alert-danger");
      resultado.innerHTML = `❌ Erro: ${data.erro || "Erro ao gerar contestação"}`;
    }
  });
</script>

</body>
</html>

