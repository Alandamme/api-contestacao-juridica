<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Contesta√ß√£o Jur√≠dica com IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body { background: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    h1 { font-family: 'Segoe UI', Tahoma, sans-serif; }
    .btn-primary { background-color: #5a5af5; border: none; }
    .btn-primary:hover { background-color: #4948e0; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4 text-center"><i class="fas fa-gavel"></i> Gerador de Contesta√ß√£o Jur√≠dica com IA</h1>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-file-upload me-2"></i>1. Enviar Peti√ß√£o Inicial (PDF)</h5>
        <form id="uploadForm">
          <input type="file" id="pdfInput" name="file" accept="application/pdf" class="form-control mb-3" required>
          <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Enviar e Analisar</button>
        </form>
        <div id="uploadStatus" class="mt-3"></div>
      </div>
    </div>

    <div class="card mb-4 d-none" id="dadosExtraidosCard">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-search me-2"></i>üîç Dados Extra√≠dos da Peti√ß√£o</h5>
        <pre id="dadosExtraidos" class="bg-white p-3 border rounded"></pre>
      </div>
    </div>

    <div class="card mb-4 d-none" id="formAdvogadoCard">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-id-badge me-2"></i>2. Dados do Advogado</h5>
        <form id="formGerar">
          <div class="mb-3">
            <label for="nomeAdvogado" class="form-label">Nome do Advogado</label>
            <input type="text" class="form-control" id="nomeAdvogado" required>
          </div>
          <div class="mb-3">
            <label for="oab" class="form-label">N√∫mero da OAB</label>
            <input type="text" class="form-control" id="oab" required>
          </div>
          <div class="mb-3">
            <label for="uf" class="form-label">Estado (UF)</label>
            <input type="text" class="form-control" id="uf" maxlength="2" required>
          </div>
          <button type="submit" class="btn btn-success"><i class="fas fa-file-contract me-2"></i>Gerar Contesta√ß√£o</button>
        </form>
      </div>
    </div>

    <div class="card d-none" id="resultadoCard">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-check-circle me-2 text-success"></i>‚úÖ Contesta√ß√£o Gerada</h5>
        <p id="preview"></p>
        <a id="downloadLink" class="btn btn-outline-primary" href="#" target="_blank">
          <i class="fas fa-download me-2"></i>Baixar Contesta√ß√£o (Word)
        </a>
      </div>
    </div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm'),
          formGerar = document.getElementById('formGerar'),
          sessionFile = '', dadosExtraidos = {};

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = document.getElementById('pdfInput').files[0];
      const fd = new FormData(); fd.append('file', f);
      const st = document.getElementById('uploadStatus');
      st.innerHTML = '‚è≥ Enviando...';

      try {
        const res = await fetch('/api/upload', { method:'POST', body: fd });
        const data = await res.json();
        if (res.ok) {
          sessionFile = data.session_file;
          dadosExtraidos = data.dados_extraidos;
          st.innerHTML = '<span class="text-success">‚úÖ Processado com sucesso</span>';
          document.getElementById('dadosExtraidos').textContent = JSON.stringify(dadosExtraidos, null, 2);
          document.getElementById('dadosExtraidosCard').classList.remove('d-none');
          document.getElementById('formAdvogadoCard').classList.remove('d-none');
        } else st.innerHTML = `<span class="text-danger">${data.error}</span>`;
      } catch {
        st.innerHTML = '<span class="text-danger">‚ùå Erro ao enviar PDF</span>';
      }
    });

    formGerar.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        session_file: sessionFile,
        dados_reu: {
          advogado_reu: document.getElementById('nomeAdvogado').value,
          oab: document.getElementById('oab').value,
          estado: document.getElementById('uf').value.toUpperCase()
        }
      };

      try {
        const res = await fetch('/api/gerar-contestacao', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById('resultadoCard').classList.remove('d-none');
          document.getElementById('preview').textContent = data.message;
          document.getElementById('downloadLink').href = '/' + data.files.word;
        } else alert('Erro: ' + data.error);
      } catch {
        alert('‚ùå Erro ao gerar contesta√ß√£o');
      }
    });
  </script>
</body>
</html>
